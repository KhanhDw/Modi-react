{
  "project_type": "react_mantine_editor_image_optimization",
  "problem": "base64_images_causing_payload_too_large",
  "current_issue": "TextEditor_mantine converts images to base64 causing very long strings and 'file too long' errors when sending to server",
  "solution_approach": "separate_image_upload_with_url_replacement",
  "implementation_phases": [
    {
      "phase": 1,
      "name": "create_upload_api_endpoint",
      "description": "Create server API endpoint for image uploads",
      "target": "backend_server",
      "requirements": {
        "endpoint_method": "POST",
        "endpoint_url": "/api/upload/image",
        "content_type": "multipart/form-data",
        "request_format": {
          "field_name": "image",
          "data_type": "File"
        },
        "response_format": {
          "success": {
            "status": 200,
            "body": {
              "url": "string (absolute or relative URL to uploaded image)",
              "filename": "string (optional)",
              "size": "number (optional)"
            }
          },
          "error": {
            "status": 400,
            "body": {
              "error": "string (error message)"
            }
          }
        },
        "file_validation": {
          "max_size": "5MB",
          "allowed_types": [
            "image/jpeg",
            "image/png",
            "image/gif",
            "image/webp"
          ],
          "storage": "server_file_system_or_cloud_storage"
        }
      },
      "implementation_steps": [
        "Create upload directory if not exists",
        "Implement file validation middleware",
        "Handle multipart form data parsing",
        "Generate unique filename to prevent conflicts",
        "Save file to designated storage",
        "Return public URL for accessing the image"
      ]
    },
    {
      "phase": 2,
      "name": "create_image_upload_service",
      "description": "Create client-side service for uploading images",
      "target": "react_frontend",
      "file_location": "@/services/imageUploadService.js",
      "code_requirements": {
        "function_name": "uploadImage",
        "parameters": ["file (File object)"],
        "return_type": "Promise<string> (image URL)",
        "error_handling": "throw Error with meaningful message"
      },
      "implementation_template": "const uploadImage = async (file) => {\n  const formData = new FormData();\n  formData.append('image', file);\n  \n  const response = await fetch(`${import.meta.env.VITE_MAIN_BE_URL}/api/upload/image`, {\n    method: 'POST',\n    body: formData,\n    // Do NOT set Content-Type header - browser will set it automatically with boundary\n  });\n  \n  if (!response.ok) {\n    throw new Error(`Upload failed: ${response.status} ${response.statusText}`);\n  }\n  \n  const data = await response.json();\n  return data.url;\n};"
    },
    {
      "phase": 3,
      "name": "modify_text_editor_component",
      "description": "Update TextEditor_mantine to use URL instead of base64",
      "target": "TextEditor_mantine component",
      "file_location": "@/components/feature/TextEditor/TextEditor_mantine.jsx",
      "changes_required": [
        {
          "target_function": "addImageFromFile",
          "current_implementation": "uses FileReader.readAsDataURL for base64",
          "new_implementation": "uses uploadImage service and inserts URL",
          "code_replacement": {
            "from": "input.onchange = (e) => {\n  const file = e.target.files?.[0];\n  if (file) {\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      const src = e.target.result;\n      if (editor && src) {\n        editor.chain().focus().setImage({ src }).run();\n      }\n    };\n    reader.readAsDataURL(file);\n  }\n};",
            "to": "input.onchange = async (e) => {\n  const file = e.target.files?.[0];\n  if (file && editor) {\n    try {\n      // Optional: Add loading state here\n      const imageUrl = await uploadImage(file);\n      editor.chain().focus().setImage({ src: imageUrl }).run();\n    } catch (error) {\n      console.error('Failed to upload image:', error);\n      alert('Upload ảnh thất bại. Vui lòng thử lại.');\n    }\n  }\n};"
          }
        }
      ],
      "imports_to_add": [
        "import { uploadImage } from '@/services/imageUploadService';"
      ]
    },
    {
      "phase": 4,
      "name": "add_loading_state_optional",
      "description": "Add visual feedback during upload process",
      "target": "TextEditor_mantine component",
      "optional": true,
      "implementation_suggestions": [
        "Add useState for upload loading state",
        "Disable image buttons during upload",
        "Show spinner or progress indicator",
        "Revert changes if upload fails"
      ]
    },
    {
      "phase": 5,
      "name": "handle_existing_base64_images",
      "description": "Migration strategy for existing base64 images",
      "target": "both_frontend_backend",
      "approaches": [
        {
          "approach": "keep_existing_base64",
          "description": "Keep base64 images as-is for existing content, only new images use URLs",
          "pros": "No data migration needed",
          "cons": "Large payloads remain for old content"
        },
        {
          "approach": "migrate_on_edit",
          "description": "Convert base64 to URLs when editing existing content",
          "implementation": "When loading content with base64 images, automatically upload and replace them"
        }
      ]
    },
    {
      "phase": 6,
      "name": "error_handling_improvements",
      "description": "Comprehensive error handling for upload failures",
      "target": "TextEditor_mantine component",
      "error_scenarios": [
        "Network failure",
        "File too large",
        "Invalid file type",
        "Server error"
      ],
      "handling_strategies": [
        "Show user-friendly error messages",
        "Allow retry failed uploads",
        "Validate file before upload attempt"
      ]
    }
  ],
  "migration_considerations": {
    "backward_compatibility": "Existing base64 images will still work",
    "data_consistency": "New images will use URLs, creating mixed content",
    "cleanup_strategy": "Consider periodic cleanup of unused uploaded images"
  },
  "testing_scenarios": [
    "Upload JPEG image < 1MB - should succeed",
    "Upload PNG image < 1MB - should succeed",
    "Upload file > 5MB - should show error",
    "Upload non-image file - should show error",
    "Network disconnect during upload - should handle gracefully",
    "Edit existing content with base64 - should preserve base64 images"
  ],
  "success_criteria": [
    "Image uploads no longer use base64 in editor content",
    "API payload size reduced significantly",
    "No 'file too long' errors during form submission",
    "Images display correctly in editor after upload",
    "Error handling provides clear user feedback"
  ]
}
